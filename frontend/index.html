<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Crypto Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #020617; }
    .watermark {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 0;
      font-size: clamp(4rem, 12vw, 10rem);
      font-weight: 800;
      letter-spacing: 0.2em;
      color: rgba(148, 163, 184, 0.05);
      text-transform: uppercase;
      user-select: none;
    }
    .content-layer {
      position: relative;
      z-index: 10;
    }
  </style>
</head>
<body class="min-h-screen text-slate-100">
  <div class="watermark">AI_Aadam</div>

  <div class="content-layer">
    <div class="max-w-6xl mx-auto py-4 px-4 space-y-4">
      <!-- Header -->
      <header class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold tracking-tight">AI Crypto Dashboard</h1>
          <p class="text-slate-400 text-sm">
            TradingView chart + AI signals (rules + ML + OpenAI) from your Python backend
          </p>
        </div>
        <div class="text-xs text-slate-500">
          Backend: live
        </div>
      </header>

      <!-- Controls -->
      <section class="bg-slate-900/60 border border-slate-700/60 rounded-xl p-3 flex flex-wrap gap-3 items-end">
        <div>
          <label class="block text-xs uppercase text-slate-400 mb-1">Symbol</label>
          <input
            id="symbolInput"
            type="text"
            value="BTCUSDT"
            class="bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm font-mono w-32 focus:outline-none focus:ring-2 focus:ring-emerald-500"
          />
        </div>

        <div>
          <label class="block text-xs uppercase text-slate-400 mb-1">Interval (rules)</label>
          <select
            id="intervalSelect"
            class="bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
          >
            <option value="1m">1m</option>
            <option value="5m">5m</option>
            <option value="15m">15m</option>
            <option value="30m">30m</option>
            <option value="1h" selected>1h</option>
            <option value="4h">4h</option>
            <option value="1d">1d</option>
          </select>
        </div>

        <button
          id="updateBtn"
          class="bg-emerald-600 hover:bg-emerald-500 text-sm font-semibold px-4 py-2 rounded-lg transition"
        >
          Sync AI with chart
        </button>

        <p class="text-xs text-slate-500 ml-auto">
          TradingView chart symbol must match your backend symbol (e.g. BINANCE:BTCUSDT).
        </p>
      </section>

      <!-- Main grid: chart + AI + risk -->
      <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- TradingView chart -->
        <div class="lg:col-span-2 bg-slate-900/60 border border-slate-700/60 rounded-xl p-2">
          <div class="tradingview-widget-container" style="height: 540px;">
            <div id="tradingview_chart" style="height: 100%;"></div>
            <div class="text-[10px] text-slate-500 mt-1">
              Charts by
              <a href="https://www.tradingview.com" rel="noopener nofollow" target="_blank" class="underline">
                TradingView
              </a>
            </div>
            <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
            <script type="text/javascript">
              let tvWidget;
              function initTradingView() {
                tvWidget = new TradingView.widget({
                  "width": "100%",
                  "height": 520,
                  "symbol": "BINANCE:BTCUSDT",
                  "interval": "60",
                  "timezone": "Etc/UTC",
                  "theme": "dark",
                  "style": "1",
                  "locale": "en",
                  "toolbar_bg": "#020617",
                  "enable_publishing": false,
                  "allow_symbol_change": true,
                  "container_id": "tradingview_chart"
                });
              }
              document.addEventListener("DOMContentLoaded", initTradingView);
            </script>
          </div>
        </div>

        <!-- AI Signal panel -->
        <div class="bg-slate-900/60 border border-slate-700/60 rounded-xl p-4 flex flex-col gap-4">
          <div>
            <h2 class="text-sm font-semibold mb-1">AI Signal</h2>
            <p class="text-xs text-slate-400 mb-2">
              Rule-based signals + OpenAI BUY/HOLD/SELL decision.
            </p>

            <!-- Rule-based signal badge -->
            <div id="signalBadge" class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-800 border border-slate-600">
              <span class="h-2 w-2 rounded-full bg-slate-500" id="signalDot"></span>
              <span class="text-xs uppercase tracking-wide" id="signalText">No data</span>
            </div>

            <!-- ML / AI prediction badge -->
            <div id="mlBadge" class="mt-2 inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-800 border border-slate-600">
              <span class="h-2 w-2 rounded-full bg-slate-500" id="mlDot"></span>
              <span class="text-[10px] uppercase tracking-wide text-slate-300">AI:</span>
              <span class="text-xs uppercase tracking-wide" id="mlText">No prediction</span>
            </div>

            <!-- ⭐ NEW — AI Timeframe Selector -->
            <div class="mt-2">
              <label class="block text-[10px] uppercase text-slate-400 mb-1">AI Timeframe</label>
              <select id="aiTimeframeSelect" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs">
                <option value="1m">1m</option>
                <option value="5m">5m</option>
                <option value="15m" selected>15m</option>
              </select>
            </div>

            <div class="mt-3 text-xs text-slate-400 space-y-1">
              <div>Symbol: <span id="aiSymbol" class="font-mono text-slate-100">–</span></div>
              <div>Interval (rules): <span id="aiInterval" class="font-mono text-slate-100">–</span></div>
              <div>Last updated: <span id="aiUpdated" class="font-mono text-slate-100">–</span></div>
            </div>
          </div>

          <div class="border-t border-slate-700/70 pt-3">
            <h3 class="text-xs font-semibold text-slate-300 mb-1">Recent signals</h3>
            <div id="signalHistory" class="space-y-1 max-h-40 overflow-y-auto text-xs text-slate-300 font-mono">
              <div class="text-slate-500">No history yet.</div>
            </div>
          </div>

          <!-- OpenAI multi-timeframe signal -->
          <div class="border-t border-slate-700/70 pt-3 space-y-2">
            <div class="flex items-center justify-between">
              <h3 class="text-xs font-semibold text-slate-300">AI Multi-TF Signal (OpenAI)</h3>
              <button
                id="btn-ai-signals-openai"
                class="text-[11px] px-2 py-1 rounded-lg border border-emerald-500 text-emerald-300 hover:bg-emerald-500/10 transition"
              >
                Analyze all timeframes
              </button>
            </div>
            <pre
              id="ai-signals-openai-box"
              class="text-[11px] whitespace-pre-wrap bg-slate-950/60 border border-slate-700/70 rounded-lg p-2 text-slate-200 min-h-[80px]"
            >Click "Analyze all timeframes" to get OpenAI signal here.</pre>
          </div>

          <button
            id="autoToggle"
            class="mt-auto text-xs px-3 py-1.5 rounded-lg border border-slate-600 text-slate-300 hover:bg-slate-800 transition self-start"
          >
            Auto-refresh: ON (30s)
          </button>
        </div>

        <!-- Risk Panel (unchanged) -->
        <!-- (kept as-is to save space, but it's identical to yours) -->
      </section>

      <!-- Image AI Section (unchanged) -->
      <!-- (kept as-is) -->
    </div>
  </div>

  <!-- Credits (unchanged) -->
  <div class="fixed bottom-4 right-4 z-20 text-[10px] text-slate-400 space-y-1 text-right">
    <div class="text-xs font-semibold text-slate-300">
      Created by <span class="text-emerald-400">aadam</span>
    </div>
    <div>
      TikTok:
      <a href="https://www.tiktok.com/@ai_aadam"
         target="_blank"
         rel="noopener noreferrer"
         class="underline hover:text-emerald-400">
        @ai_aadam
      </a>
    </div>
    <div>
      Donate:
      <a href="https://www.paypal.com/paypalme/Aadam800"
         target="_blank"
         rel="noopener noreferrer"
         class="underline hover:text-emerald-400">
        paypal.me/Aadam800
      </a>
    </div>
    <div>
      Contact me: <span class="text-slate-200">07506254663</span>
    </div>
  </div>

  <script>
    const apiBase = "https://aadamautotrades.onrender.com";

    const symbolInput = document.getElementById("symbolInput");
    const intervalSelect = document.getElementById("intervalSelect");
    const updateBtn = document.getElementById("updateBtn");

    const signalBadge = document.getElementById("signalBadge");
    const signalDot = document.getElementById("signalDot");
    const signalText = document.getElementById("signalText");
    const aiSymbol = document.getElementById("aiSymbol");
    const aiInterval = document.getElementById("aiInterval");
    const aiUpdated = document.getElementById("aiUpdated");
    const signalHistory = document.getElementById("signalHistory");
    const autoToggle = document.getElementById("autoToggle");

    const mlBadge = document.getElementById("mlBadge");
    const mlDot = document.getElementById("mlDot");
    const mlText = document.getElementById("mlText");

    const aiTimeframeSelect = document.getElementById("aiTimeframeSelect");

    let autoOn = true;
    let autoTimer = null;
    let currentSymbol = symbolInput.value.trim().toUpperCase();

    function formatTimestamp(tsSeconds) {
      if (!tsSeconds) return "–";
      const d = new Date(tsSeconds * 1000);
      return d.toLocaleString("en-GB");
    }

    function updateSignalUI(data) {
      const signals = data.signal;
      if (!signals || !signals.length) {
        signalText.textContent = "No data";
        signalBadge.className = "inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-800 border border-slate-600";
        signalDot.className = "h-2 w-2 rounded-full bg-slate-500";
        aiSymbol.textContent = data.symbol || "–";
        aiInterval.textContent = data.interval || "–";
        aiUpdated.textContent = "–";
        signalHistory.innerHTML = '<div class="text-slate-500">No history yet.</div>';
        return;
      }

      const lastSignal = signals[signals.length - 1];
      const lastTime = data.time[data.time.length - 1];

      signalText.textContent = lastSignal;

      signalBadge.className = "inline-flex items-center gap-2 px-3 py-1 rounded-full border";
      if (lastSignal === "BUY") {
        signalBadge.classList.add("bg-emerald-500/10", "border-emerald-500/60", "text-emerald-300");
        signalDot.className = "h-2 w-2 rounded-full bg-emerald-400";
      } else if (lastSignal === "SELL") {
        signalBadge.classList.add("bg-rose-500/10", "border-rose-500/60", "text-rose-300");
        signalDot.className = "h-2 w-2 rounded-full bg-rose-400";
      } else {
        signalBadge.classList.add("bg-slate-700/40", "border-slate-500/60", "text-slate-100");
        signalDot.className = "h-2 w-2 rounded-full bg-slate-400";
      }

      aiSymbol.textContent = data.symbol || "–";
      aiInterval.textContent = data.interval || "–";
      aiUpdated.textContent = formatTimestamp(lastTime);

      const items = [];
      const len = Math.min(signals.length, 20);
      for (let i = 0; i < len; i++) {
        const s = signals[signals.length - 1 - i];
        const t = data.time[data.time.length - 1 - i];
        const color =
          s === "BUY"
            ? "text-emerald-300"
            : s === "SELL"
            ? "text-rose-300"
            : "text-slate-300";
        items.push(
          `<div class="flex justify-between gap-2">
             <span class="${color}">${s}</span>
             <span class="text-slate-500">${formatTimestamp(t)}</span>
           </div>`
        );
      }
      signalHistory.innerHTML = items.join("");
    }

    function updateMlUI(prediction) {
      const p = prediction || "HOLD";

      mlBadge.className = "mt-2 inline-flex items-center gap-2 px-3 py-1 rounded-full border";
      if (p === "BUY") {
        mlBadge.classList.add("bg-emerald-500/10", "border-emerald-500/60", "text-emerald-300");
        mlDot.className = "h-2 w-2 rounded-full bg-emerald-400";
      } else if (p === "SELL") {
        mlBadge.classList.add("bg-rose-500/10", "border-rose-500/60", "text-rose-300");
        mlDot.className = "h-2 w-2 rounded-full bg-rose-400";
      } else {
        mlBadge.classList.add("bg-slate-700/40", "border-slate-500/60", "text-slate-100");
        mlDot.className = "h-2 w-2 rounded-full bg-slate-400";
      }

      mlText.textContent = p;
    }

    async function fetchSignals(intervalOverride) {
      const symbol = currentSymbol;
      const interval = intervalOverride || intervalSelect.value;
      const url = `${apiBase}/crypto/${symbol}?interval=${interval}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("API error " + res.status);
      return res.json();
    }

    // ⭐ NEW — OpenAI AI signal requester
    async function fetchAiSignal() {
      const symbol = currentSymbol;
      const aiTimeframe = aiTimeframeSelect.value;
      const url = `${apiBase}/ai_signal/${symbol}/${aiTimeframe}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("AI API error " + res.status);
      return res.json();
    }

    async function refreshSignals() {
      try {
        updateBtn.disabled = true;
        updateBtn.textContent = "Loading...";

        const [data, ai] = await Promise.all([
          fetchSignals(),
          fetchAiSignal(),
        ]);

        updateSignalUI(data);
        updateMlUI(ai.prediction);
      } catch (err) {
        console.error(err);
        signalText.textContent = "Error";
        signalBadge.className =
          "inline-flex items-center gap-2 px-3 py-1 rounded-full bg-rose-500/10 border border-rose-500/60 text-rose-300";
        signalDot.className = "h-2 w-2 rounded-full bg-rose-400";
        updateMlUI("HOLD");
      } finally {
        updateBtn.disabled = false;
        updateBtn.textContent = "Sync AI with chart";
      }
    }

    function startAuto() {
      if (autoTimer) clearInterval(autoTimer);
      autoTimer = setInterval(() => {
        if (autoOn) refreshSignals();
      }, 30000);
    }

    autoToggle.addEventListener("click", () => {
      autoOn = !autoOn;
      if (autoOn) {
        autoToggle.textContent = "Auto-refresh: ON (30s)";
        autoToggle.classList.remove("bg-slate-800");
        startAuto();
      } else {
        autoToggle.textContent = "Auto-refresh: OFF";
        autoToggle.classList.add("bg-slate-800");
      }
    });

    function updateSymbolFromInput() {
      currentSymbol = symbolInput.value.trim().toUpperCase();
      symbolInput.value = currentSymbol;
      if (window.tvWidget && tvWidget.chart) {
        try {
          tvWidget.chart().setSymbol(`BINANCE:${currentSymbol}`);
        } catch (e) {
          console.warn("Unable to update TradingView symbol", e);
        }
      }
    }

    updateBtn.addEventListener("click", () => {
      updateSymbolFromInput();
      refreshSignals();
    });

    symbolInput.addEventListener("keyup", (e) => {
      if (e.key === "Enter") {
        updateSymbolFromInput();
        refreshSignals();
      }
    });

    // (rest of your risk + image AI JS remains unchanged from your original code)

    // initial load
    updateSymbolFromInput();
    refreshSignals();
    startAuto();
  </script>
</body>
</html>
