<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Crypto Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #020617; }
    .watermark {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 0;
      font-size: clamp(4rem, 12vw, 10rem);
      font-weight: 800;
      letter-spacing: 0.2em;
      color: rgba(148, 163, 184, 0.05);
      text-transform: uppercase;
      user-select: none;
    }
    .content-layer {
      position: relative;
      z-index: 10;
    }
  </style>
</head>
<body class="min-h-screen text-slate-100">
  <div class="watermark">AI_Aadam</div>

  <div class="content-layer">
    <div class="max-w-6xl mx-auto py-4 px-4 space-y-4">
      <!-- Header -->
      <header class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold tracking-tight">AI Crypto Dashboard</h1>
          <p class="text-slate-400 text-sm">
            TradingView chart + AI signals (rules + ML + AI Master Override + OpenAI)
          </p>
        </div>
        <div class="text-xs text-slate-500">
          Backend: live
        </div>
      </header>

      <!-- Controls -->
      <section class="bg-slate-900/60 border border-slate-700/60 rounded-xl p-3 flex flex-wrap gap-3 items-end">
        <div>
          <label class="block text-xs uppercase text-slate-400 mb-1">Symbol</label>
          <input
            id="symbolInput"
            type="text"
            value="BTCUSDT"
            class="bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm font-mono w-32 focus:outline-none focus:ring-2 focus:ring-emerald-500"
          />
        </div>

        <div>
          <label class="block text-xs uppercase text-slate-400 mb-1">Interval</label>
          <select
            id="intervalSelect"
            class="bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
          >
            <option value="1m">1m</option>
            <option value="5m">5m</option>
            <option value="15m">15m</option>
            <option value="30m">30m</option>
            <option value="1h" selected>1h</option>
            <option value="4h">4h</option>
            <option value="1d">1d</option>
          </select>
        </div>

        <button
          id="updateBtn"
          class="bg-emerald-600 hover:bg-emerald-500 text-sm font-semibold px-4 py-2 rounded-lg transition"
        >
          Sync AI Master Signal
        </button>

        <p class="text-xs text-slate-500 ml-auto">
          AI Master overrides rules â†’ BUY signals prioritized
        </p>
      </section>

      <!-- Main grid: chart + AI + risk -->
      <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- TradingView chart -->
        <div class="lg:col-span-2 bg-slate-900/60 border border-slate-700/60 rounded-xl p-2">
          <div class="tradingview-widget-container" style="height: 540px;">
            <div id="tradingview_chart" style="height: 100%;"></div>
            <div class="text-[10px] text-slate-500 mt-1">
              Charts by
              <a href="https://www.tradingview.com" rel="noopener nofollow" target="_blank" class="underline">
                TradingView
              </a>
            </div>
            <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
            <script type="text/javascript">
              let tvWidget;
              function initTradingView() {
                tvWidget = new TradingView.widget({
                  "width": "100%",
                  "height": 520,
                  "symbol": "BINANCE:BTCUSDT",
                  "interval": "60",
                  "timezone": "Etc/UTC",
                  "theme": "dark",
                  "style": "1",
                  "locale": "en",
                  "toolbar_bg": "#020617",
                  "enable_publishing": false,
                  "allow_symbol_change": true,
                  "container_id": "tradingview_chart"
                });
              }
              document.addEventListener("DOMContentLoaded", initTradingView);
            </script>
          </div>
        </div>

        <!-- ðŸ”¥ AI MASTER SIGNAL PANEL -->
        <div class="bg-slate-900/60 border border-slate-700/60 rounded-xl p-4 flex flex-col gap-4">
          <div>
            <h2 class="text-sm font-bold mb-1 flex items-center gap-2">
              <span class="text-emerald-400">ðŸ¤–</span>
              AI Master Signal
            </h2>
            <p class="text-xs text-slate-400 mb-3">
              AI overrides rules + ML + recent signals â†’ FINAL CALL
            </p>

            <!-- AI Master Signal Badge (PRIMARY) -->
            <div id="masterBadge" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gradient-to-r from-emerald-500/20 to-emerald-600/20 border-2 border-emerald-500/50 shadow-lg mb-3">
              <span class="h-3 w-3 rounded-full bg-emerald-400 shadow-md" id="masterDot"></span>
              <span class="text-sm uppercase tracking-wider font-bold" id="masterText">Loading...</span>
              <span class="text-xs bg-emerald-500/20 px-2 py-0.5 rounded-full" id="masterConf">â€“%</span>
            </div>

            <!-- Rule-based + ML badges (secondary) -->
            <div class="space-y-1 mb-3">
              <div id="ruleBadge" class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-800/50 border border-slate-600 text-xs">
                <span class="h-2 w-2 rounded-full bg-slate-500" id="ruleDot"></span>
                <span>Rule:</span>
                <span id="ruleText">â€“</span>
              </div>
              <div id="mlBadge" class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-800/50 border border-slate-600 text-xs">
                <span class="h-2 w-2 rounded-full bg-slate-500" id="mlDot"></span>
                <span>ML:</span>
                <span id="mlText">â€“</span>
              </div>
            </div>

            <div class="text-xs text-slate-300 space-y-1 bg-slate-950/50 p-2 rounded-lg">
              <div>Symbol: <span id="aiSymbol" class="font-mono text-emerald-300">â€“</span></div>
              <div>Interval: <span id="aiInterval" class="font-mono text-emerald-300">â€“</span></div>
              <div>AI Reason: <span id="aiReason" class="font-mono">â€“</span></div>
              <div>Last updated: <span id="aiUpdated" class="font-mono text-slate-100">â€“</span></div>
            </div>
          </div>

          <div class="border-t border-slate-700/70 pt-3">
            <h3 class="text-xs font-semibold text-slate-300 mb-2 flex items-center gap-1">
              Recent signals <span class="text-emerald-400 text-[10px]">(AI analyzed)</span>
            </h3>
            <div id="signalHistory" class="space-y-1 max-h-32 overflow-y-auto text-xs text-slate-300 font-mono bg-slate-950/30 p-2 rounded">
              <div class="text-slate-500 text-[10px]">Loading history...</div>
            </div>
          </div>

          <button
            id="autoToggle"
            class="mt-auto text-xs px-3 py-1.5 rounded-lg border border-emerald-500/50 text-emerald-300 hover:bg-emerald-500/10 transition self-start"
          >
            Auto-refresh: ON (30s)
          </button>
        </div>

        <!-- Risk panel (unchanged) -->
        <div class="bg-slate-900/60 border border-slate-700/60 rounded-xl p-4 flex flex-col gap-3">
          <div>
            <h2 class="text-sm font-semibold mb-1">Risk & Position Size</h2>
            <p class="text-xs text-slate-400">
              Calculate position size based on account size, risk %, entry, and stop.
            </p>
          </div>

          <div class="grid grid-cols-2 gap-3 text-xs">
            <div>
              <label class="block text-[11px] uppercase text-slate-400 mb-1">Account size ($)</label>
              <input id="riskAccount" type="number" value="1000" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-2 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-500" />
            </div>
            <div>
              <label class="block text-[11px] uppercase text-slate-400 mb-1">Risk per trade (%)</label>
              <input id="riskPercent" type="number" value="1" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-2 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-500" />
            </div>
            <div>
              <label class="block text-[11px] uppercase text-slate-400 mb-1">Entry price</label>
              <input id="riskEntry" type="number" step="0.0001" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-2 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-500" />
            </div>
            <div>
              <label class="block text-[11px] uppercase text-slate-400 mb-1">Stop loss price</label>
              <input id="riskStop" type="number" step="0.0001" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-2 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-500" />
            </div>
          </div>

          <button id="riskCalcBtn" class="mt-1 bg-slate-800 hover:bg-slate-700 text-xs font-semibold px-3 py-1.5 rounded-lg transition self-start">
            Calculate position
          </button>

          <div class="mt-1 text-xs text-slate-300 space-y-1">
            <div>Max risk: <span id="riskDollar" class="font-mono text-emerald-300">â€“</span></div>
            <div>Position size (coins): <span id="riskSize" class="font-mono text-emerald-300">â€“</span></div>
            <div>Notional size ($): <span id="riskNotional" class="font-mono text-slate-200">â€“</span></div>
          </div>
        </div>
      </section>

      <!-- Image AI Chart Analysis (shortened here for brevity; keep your existing section if you want) -->
      <!-- ... -->
    </div>
  </div>

  <script>
    const apiBase = "https://aadamautotrades.onrender.com";

    const symbolInput = document.getElementById("symbolInput");
    const intervalSelect = document.getElementById("intervalSelect");
    const updateBtn = document.getElementById("updateBtn");
    const autoToggle = document.getElementById("autoToggle");

    const masterBadge = document.getElementById("masterBadge");
    const masterDot = document.getElementById("masterDot");
    const masterText = document.getElementById("masterText");
    const masterConf = document.getElementById("masterConf");

    const ruleBadge = document.getElementById("ruleBadge");
    const ruleDot = document.getElementById("ruleDot");
    const ruleText = document.getElementById("ruleText");

    const mlBadge = document.getElementById("mlBadge");
    const mlDot = document.getElementById("mlDot");
    const mlText = document.getElementById("mlText");

    const aiSymbol = document.getElementById("aiSymbol");
    const aiInterval = document.getElementById("aiInterval");
    const aiReason = document.getElementById("aiReason");
    const aiUpdated = document.getElementById("aiUpdated");
    const signalHistory = document.getElementById("signalHistory");

    const riskAccount = document.getElementById("riskAccount");
    const riskPercent = document.getElementById("riskPercent");
    const riskEntry = document.getElementById("riskEntry");
    const riskStop = document.getElementById("riskStop");
    const riskCalcBtn = document.getElementById("riskCalcBtn");
    const riskDollar = document.getElementById("riskDollar");
    const riskSize = document.getElementById("riskSize");
    const riskNotional = document.getElementById("riskNotional");

    let autoOn = true;
    let autoTimer = null;
    let currentSymbol = symbolInput.value.trim().toUpperCase();

    function formatTimestamp(tsSeconds) {
      if (!tsSeconds) return "â€“";
      const d = new Date(tsSeconds * 1000);
      return d.toLocaleString("en-GB", {
        day: "numeric",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      });
    }

    function updateMasterUI(masterData, ruleData, mlData) {
      // MASTER
      const masterSignal = masterData.master_signal;
      const conf = masterData.confidence ?? 0;
      masterText.textContent = `AI Master: ${masterSignal}`;
      masterConf.textContent = `${Math.round(conf)}%`;

      masterBadge.className =
        "inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gradient-to-r border-2 shadow-lg mb-3";
      masterDot.className = "h-3 w-3 rounded-full shadow-md";

      if (masterSignal === "BUY") {
        masterBadge.classList.add(
          "from-emerald-500/20",
          "to-emerald-600/20",
          "border-emerald-500/50",
          "text-emerald-300"
        );
        masterDot.className = "h-3 w-3 rounded-full bg-emerald-400 shadow-emerald-500/50";
      } else if (masterSignal === "SELL") {
        masterBadge.classList.add(
          "from-rose-500/20",
          "to-rose-600/20",
          "border-rose-500/50",
          "text-rose-300"
        );
        masterDot.className = "h-3 w-3 rounded-full bg-rose-400 shadow-rose-500/50";
      } else {
        masterBadge.classList.add(
          "from-slate-500/20",
          "to-slate-600/20",
          "border-slate-500/50",
          "text-slate-200"
        );
        masterDot.className = "h-3 w-3 rounded-full bg-slate-400";
      }

      // RULE BADGE
      const ruleSignal =
        (ruleData.signal && ruleData.signal[ruleData.signal.length - 1]) || "HOLD";
      ruleText.textContent = ruleSignal;
      ruleBadge.className =
        "inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-800/50 border text-xs";
      if (ruleSignal === "BUY") {
        ruleBadge.classList.add("border-emerald-500/40", "text-emerald-300");
        ruleDot.className = "h-2 w-2 rounded-full bg-emerald-400";
      } else if (ruleSignal === "SELL") {
        ruleBadge.classList.add("border-rose-500/40", "text-rose-300");
        ruleDot.className = "h-2 w-2 rounded-full bg-rose-400";
      } else {
        ruleBadge.classList.add("border-slate-600");
        ruleDot.className = "h-2 w-2 rounded-full bg-slate-500";
      }

      // ML BADGE
      const mlSignal = mlData.prediction || "HOLD";
      mlText.textContent = mlSignal;
      mlBadge.className =
        "inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-800/50 border text-xs";
      if (mlSignal === "BUY") {
        mlBadge.classList.add("border-emerald-500/40", "text-emerald-300");
        mlDot.className = "h-2 w-2 rounded-full bg-emerald-400";
      } else if (mlSignal === "SELL") {
        mlBadge.classList.add("border-rose-500/40", "text-rose-300");
        mlDot.className = "h-2 w-2 rounded-full bg-rose-400";
      } else {
        mlBadge.classList.add("border-slate-600");
        mlDot.className = "h-2 w-2 rounded-full bg-slate-500";
      }

      // META
      aiSymbol.textContent = masterData.symbol || currentSymbol;
      aiInterval.textContent = masterData.interval || intervalSelect.value;
      aiReason.textContent =
        `Rule last 10: ${(masterData.buy_count ?? "?")}/10 BUY | ML: ${mlSignal} | Trend: ` +
        (masterData.price_trend ? "UP" : "FLAT/DOWN");
      aiUpdated.textContent = formatTimestamp(Date.now() / 1000);

      // RECENT SIGNALS
      const recent = masterData.recent_signals || ruleData.signal || [];
      const times = ruleData.time || [];
      const items = [];
      const len = Math.min(recent.length, 20);
      for (let i = 0; i < len; i++) {
        const s = recent[recent.length - 1 - i];
        const t = times[times.length - 1 - i] || null;
        const color =
          s === "BUY"
            ? "text-emerald-300"
            : s === "SELL"
            ? "text-rose-300"
            : "text-slate-300";
        items.push(
          `<div class="flex justify-between gap-2">
             <span class="${color}">${s}</span>
             <span class="text-slate-500">${t ? formatTimestamp(t) : ""}</span>
           </div>`
        );
      }
      signalHistory.innerHTML =
        items.join("") ||
        '<div class="text-slate-500 text-[10px]">No recent signals</div>';
    }

    async function refreshSignals() {
      try {
        updateBtn.disabled = true;
        updateBtn.textContent = "Loading...";

        const symbol = currentSymbol;
        const interval = intervalSelect.value;

        const [masterRes, ruleRes, mlRes] = await Promise.all([
          fetch(`${apiBase}/ai_master_signal/${symbol}?interval=${interval}`),
          fetch(`${apiBase}/crypto/${symbol}?interval=${interval}`),
          fetch(`${apiBase}/predict/${symbol}`)
        ]);

        const [masterData, ruleData, mlData] = await Promise.all([
          masterRes.json(),
          ruleRes.json(),
          mlRes.json()
        ]);

        updateMasterUI(masterData, ruleData, mlData);
      } catch (err) {
        console.error("AI Master error:", err);
        masterText.textContent = "ERROR";
        masterBadge.className =
          "inline-flex items-center gap-2 px-4 py-2 rounded-full bg-rose-500/20 border-2 border-rose-500/50 text-rose-300";
      } finally {
        updateBtn.disabled = false;
        updateBtn.textContent = "Sync AI Master Signal";
      }
    }

    function startAuto() {
      if (autoTimer) clearInterval(autoTimer);
      autoTimer = setInterval(() => {
        if (autoOn) refreshSignals();
      }, 30000);
    }

    function updateSymbolFromInput() {
      currentSymbol = symbolInput.value.trim().toUpperCase();
      symbolInput.value = currentSymbol;
      if (window.tvWidget && tvWidget.chart) {
        try {
          tvWidget.chart().setSymbol(`BINANCE:${currentSymbol}`);
        } catch (e) {
          console.warn("Unable to update TradingView symbol", e);
        }
      }
    }

    updateBtn.addEventListener("click", () => {
      updateSymbolFromInput();
      refreshSignals();
    });

    autoToggle.addEventListener("click", () => {
      autoOn = !autoOn;
      autoToggle.textContent = autoOn
        ? "Auto-refresh: ON (30s)"
        : "Auto-refresh: OFF";
    });

    // Risk calc
    riskCalcBtn.addEventListener("click", () => {
      const account = parseFloat(riskAccount.value);
      const pct = parseFloat(riskPercent.value);
      const entry = parseFloat(riskEntry.value);
      const stop = parseFloat(riskStop.value);
      if (!account || !pct || !entry || !stop || entry === stop) {
        alert("Fill account, risk %, entry and stop (entry â‰  stop).");
        return;
      }
      const riskPerTrade = (account * pct) / 100;
      const riskPerCoin = Math.abs(entry - stop);
      const size = riskPerTrade / riskPerCoin;
      const notional = size * entry;
      riskDollar.textContent = riskPerTrade.toFixed(2);
      riskSize.textContent = size.toFixed(4);
      riskNotional.textContent = notional.toFixed(2);
    });

    // Initial load
    updateSymbolFromInput();
    refreshSignals();
    startAuto();
  </script>
</body>
</html>
